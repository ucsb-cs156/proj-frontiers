<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GithubTeamService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontiers</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.frontiers.services</a> &gt; <span class="el_source">GithubTeamService.java</span></div><h1>GithubTeamService.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.frontiers.services;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import edu.ucsb.cs156.frontiers.entities.Course;
import edu.ucsb.cs156.frontiers.entities.Team;
import edu.ucsb.cs156.frontiers.enums.TeamStatus;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.util.HashMap;
import java.util.Map;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

<span class="fc" id="L24">@Slf4j</span>
@Service
public class GithubTeamService {

  private final JwtService jwtService;
  private final ObjectMapper objectMapper;
  private final RestTemplate restTemplate;

  public GithubTeamService(
<span class="fc" id="L33">      JwtService jwtService, ObjectMapper objectMapper, RestTemplateBuilder builder) {</span>
<span class="fc" id="L34">    this.jwtService = jwtService;</span>
<span class="fc" id="L35">    this.objectMapper = objectMapper;</span>
<span class="fc" id="L36">    this.objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc" id="L37">    this.restTemplate = builder.build();</span>
<span class="fc" id="L38">  }</span>

  /**
   * Creates a team on GitHub if it doesn't exist, or returns the existing team ID.
   *
   * @param team The team to create
   * @param course The course containing the organization
   * @return The GitHub team ID
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public Integer createOrGetTeamId(Team team, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
    // First check if team already exists by getting team info
<span class="fc" id="L53">    Integer existingTeamId = getTeamId(team.getName(), course);</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">    if (existingTeamId != null) {</span>
<span class="fc" id="L55">      return existingTeamId;</span>
    }

    // Create the team if it doesn't exist
<span class="fc" id="L59">    return createTeam(team.getName(), course);</span>
  }

  /**
   * Gets the team ID for a team name, returns null if team doesn't exist.
   *
   * @param teamName The name of the team
   * @param course The course containing the organization
   * @return The GitHub team ID or null if not found
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public Integer getTeamId(String teamName, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L74">    String endpoint = &quot;https://api.github.com/orgs/&quot; + course.getOrgName() + &quot;/teams/&quot; + teamName;</span>
<span class="fc" id="L75">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L76">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L77">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L78">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L79">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>
<span class="fc" id="L80">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

    try {
<span class="fc" id="L83">      ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L84">          restTemplate.exchange(endpoint, HttpMethod.GET, entity, String.class);</span>
<span class="fc" id="L85">      JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L86">      return responseJson.get(&quot;id&quot;).asInt();</span>
<span class="fc" id="L87">    } catch (HttpClientErrorException e) {</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">      if (e.getStatusCode().value() == 404) {</span>
<span class="fc" id="L89">        return null; // Team doesn't exist</span>
      }
<span class="fc" id="L91">      throw e;</span>
    }
  }

  /**
   * Creates a new team on GitHub.
   *
   * @param teamName The name of the team to create
   * @param course The course containing the organization
   * @return The GitHub team ID
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  private Integer createTeam(String teamName, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L107">    String endpoint = &quot;https://api.github.com/orgs/&quot; + course.getOrgName() + &quot;/teams&quot;;</span>
<span class="fc" id="L108">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L109">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L110">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L111">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L112">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>

<span class="fc" id="L114">    Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="fc" id="L115">    body.put(&quot;name&quot;, teamName);</span>
<span class="fc" id="L116">    body.put(&quot;privacy&quot;, &quot;closed&quot;); // Teams are private by default</span>
<span class="fc" id="L117">    String bodyAsJson = objectMapper.writeValueAsString(body);</span>
<span class="fc" id="L118">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(bodyAsJson, headers);</span>

<span class="fc" id="L120">    ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L121">        restTemplate.exchange(endpoint, HttpMethod.POST, entity, String.class);</span>
<span class="fc" id="L122">    JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L123">    Integer teamId = responseJson.get(&quot;id&quot;).asInt();</span>
<span class="fc" id="L124">    log.info(</span>
<span class="fc" id="L125">        &quot;Created team '{}' with ID {} in organization {}&quot;, teamName, teamId, course.getOrgName());</span>
<span class="fc" id="L126">    return teamId;</span>
  }

  /**
   * Gets the current team membership status for a user.
   *
   * @param githubLogin The GitHub login of the user
   * @param teamId The GitHub team ID
   * @param course The course containing the organization
   * @return The team status of the user
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public TeamStatus getTeamMembershipStatus(String githubLogin, Integer teamId, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc bfc" id="L142" title="All 2 branches covered.">    if (githubLogin == null) {</span>
<span class="fc" id="L143">      return TeamStatus.NO_GITHUB_ID;</span>
    }

<span class="fc" id="L146">    String endpoint =</span>
        &quot;https://api.github.com/orgs/&quot;
<span class="fc" id="L148">            + course.getOrgName()</span>
            + &quot;/teams/&quot;
            + teamId
            + &quot;/memberships/&quot;
            + githubLogin;
<span class="fc" id="L153">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L154">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L155">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L156">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L157">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>
<span class="fc" id="L158">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

    try {
<span class="fc" id="L161">      ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L162">          restTemplate.exchange(endpoint, HttpMethod.GET, entity, String.class);</span>
<span class="fc" id="L163">      JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L164">      String role = responseJson.get(&quot;role&quot;).asText();</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">      return &quot;maintainer&quot;.equalsIgnoreCase(role)</span>
<span class="fc" id="L166">          ? TeamStatus.TEAM_MAINTAINER</span>
<span class="fc" id="L167">          : TeamStatus.TEAM_MEMBER;</span>
<span class="fc" id="L168">    } catch (HttpClientErrorException e) {</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">      if (e.getStatusCode().value() == 404) {</span>
<span class="fc" id="L170">        return TeamStatus.NOT_ORG_MEMBER; // User is not a member of the team</span>
      }
<span class="fc" id="L172">      throw e;</span>
    }
  }

  /**
   * Adds a member to a GitHub team.
   *
   * @param githubLogin The GitHub login of the user to add
   * @param teamId The GitHub team ID
   * @param role The role to assign (&quot;member&quot; or &quot;maintainer&quot;)
   * @param course The course containing the organization
   * @return The resulting team status
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public TeamStatus addTeamMember(String githubLogin, Integer teamId, String role, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L190">    String endpoint =</span>
        &quot;https://api.github.com/orgs/&quot;
<span class="fc" id="L192">            + course.getOrgName()</span>
            + &quot;/teams/&quot;
            + teamId
            + &quot;/memberships/&quot;
            + githubLogin;
<span class="fc" id="L197">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L198">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L199">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L200">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L201">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>

<span class="fc" id="L203">    Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="fc" id="L204">    body.put(&quot;role&quot;, role);</span>
<span class="fc" id="L205">    String bodyAsJson = objectMapper.writeValueAsString(body);</span>
<span class="fc" id="L206">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(bodyAsJson, headers);</span>

<span class="fc" id="L208">    ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L209">        restTemplate.exchange(endpoint, HttpMethod.PUT, entity, String.class);</span>
<span class="fc" id="L210">    JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L211">    String resultRole = responseJson.get(&quot;role&quot;).asText();</span>
<span class="fc" id="L212">    log.info(&quot;Added user '{}' to team ID {} with role '{}'&quot;, githubLogin, teamId, resultRole);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">    return &quot;maintainer&quot;.equalsIgnoreCase(resultRole)</span>
<span class="fc" id="L214">        ? TeamStatus.TEAM_MAINTAINER</span>
<span class="fc" id="L215">        : TeamStatus.TEAM_MEMBER;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>