<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GithubTeamService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontiers</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.frontiers.services</a> &gt; <span class="el_source">GithubTeamService.java</span></div><h1>GithubTeamService.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.frontiers.services;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import edu.ucsb.cs156.frontiers.entities.Course;
import edu.ucsb.cs156.frontiers.entities.Team;
import edu.ucsb.cs156.frontiers.enums.TeamStatus;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.util.HashMap;
import java.util.Map;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

<span class="fc" id="L24">@Slf4j</span>
@Service
public class GithubTeamService {

  private final JwtService jwtService;
  private final ObjectMapper objectMapper;
  private final RestTemplate restTemplate;

  public GithubTeamService(
<span class="fc" id="L33">      JwtService jwtService, ObjectMapper objectMapper, RestTemplateBuilder builder) {</span>
<span class="fc" id="L34">    this.jwtService = jwtService;</span>
<span class="fc" id="L35">    this.objectMapper = objectMapper;</span>
<span class="fc" id="L36">    this.objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc" id="L37">    this.restTemplate = builder.build();</span>
<span class="fc" id="L38">  }</span>

  /**
   * Creates a team on GitHub if it doesn't exist, or returns the existing team ID.
   *
   * @param team The team to create
   * @param course The course containing the organization
   * @return The GitHub team ID
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public Integer createOrGetTeamId(Team team, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
    // First check if team already exists by getting team info
<span class="fc" id="L53">    Integer existingTeamId = getTeamId(team.getName(), course);</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">    if (existingTeamId != null) {</span>
<span class="fc" id="L55">      return existingTeamId;</span>
    }

    // Create the team if it doesn't exist
<span class="fc" id="L59">    return createTeam(team.getName(), course);</span>
  }

  /**
   * Get the org id, given the org name.
   *
   * &lt;p&gt;Note: in the future, it would be better to cache this value in the Course row in the
   * database at the time the Github App is linked to the org, since it doesn't change.
   *
   * @param orgName
   * @param course
   * @return
   * @throws JsonProcessingException
   * @throws NoSuchAlgorithmException
   * @throws InvalidKeySpecException
   */
  public Integer getOrgId(String orgName, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L77">    String endpoint = &quot;https://api.github.com/orgs/&quot; + orgName;</span>
<span class="fc" id="L78">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L79">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L80">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L81">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L82">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>
<span class="fc" id="L83">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

<span class="fc" id="L85">    ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L86">        restTemplate.exchange(endpoint, HttpMethod.GET, entity, String.class);</span>
<span class="fc" id="L87">    JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L88">    return responseJson.get(&quot;id&quot;).asInt();</span>
  }

  /**
   * Gets the team ID for a team name, returns null if team doesn't exist.
   *
   * @param teamName The name of the team
   * @param course The course containing the organization
   * @return The GitHub team ID or null if not found
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public Integer getTeamId(String teamName, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L103">    String endpoint = &quot;https://api.github.com/orgs/&quot; + course.getOrgName() + &quot;/teams/&quot; + teamName;</span>
<span class="fc" id="L104">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L105">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L106">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L107">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L108">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>
<span class="fc" id="L109">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

    try {
<span class="fc" id="L112">      ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L113">          restTemplate.exchange(endpoint, HttpMethod.GET, entity, String.class);</span>
<span class="fc" id="L114">      JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L115">      return responseJson.get(&quot;id&quot;).asInt();</span>
<span class="fc" id="L116">    } catch (HttpClientErrorException e) {</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">      if (e.getStatusCode().value() == 404) {</span>
<span class="fc" id="L118">        return null; // Team doesn't exist</span>
      }
<span class="fc" id="L120">      throw e;</span>
    }
  }

  /**
   * Creates a new team on GitHub.
   *
   * @param teamName The name of the team to create
   * @param course The course containing the organization
   * @return The GitHub team ID
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  private Integer createTeam(String teamName, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L136">    String endpoint = &quot;https://api.github.com/orgs/&quot; + course.getOrgName() + &quot;/teams&quot;;</span>
<span class="fc" id="L137">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L138">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L139">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L140">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L141">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>

<span class="fc" id="L143">    Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="fc" id="L144">    body.put(&quot;name&quot;, teamName);</span>
<span class="fc" id="L145">    body.put(&quot;privacy&quot;, &quot;closed&quot;); // Teams are private by default</span>
<span class="fc" id="L146">    String bodyAsJson = objectMapper.writeValueAsString(body);</span>
<span class="fc" id="L147">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(bodyAsJson, headers);</span>

<span class="fc" id="L149">    ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L150">        restTemplate.exchange(endpoint, HttpMethod.POST, entity, String.class);</span>
<span class="fc" id="L151">    JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L152">    Integer teamId = responseJson.get(&quot;id&quot;).asInt();</span>
<span class="fc" id="L153">    log.info(</span>
<span class="fc" id="L154">        &quot;Created team '{}' with ID {} in organization {}&quot;, teamName, teamId, course.getOrgName());</span>
<span class="fc" id="L155">    return teamId;</span>
  }

  /**
   * Gets the current team membership status for a user.
   *
   * @param githubLogin The GitHub login of the user
   * @param teamId The GitHub team ID
   * @param course The course containing the organization
   * @return The team status of the user
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public TeamStatus getTeamMembershipStatus(String githubLogin, Integer teamId, Course course)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc bfc" id="L171" title="All 2 branches covered.">    if (githubLogin == null) {</span>
<span class="fc" id="L172">      return TeamStatus.NO_GITHUB_ID;</span>
    }

<span class="fc" id="L175">    String endpoint =</span>
        &quot;https://api.github.com/orgs/&quot;
<span class="fc" id="L177">            + course.getOrgName()</span>
            + &quot;/teams/&quot;
            + teamId
            + &quot;/memberships/&quot;
            + githubLogin;
<span class="fc" id="L182">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L183">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L184">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L185">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L186">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>
<span class="fc" id="L187">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

    try {
<span class="fc" id="L190">      ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L191">          restTemplate.exchange(endpoint, HttpMethod.GET, entity, String.class);</span>
<span class="fc" id="L192">      JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L193">      String role = responseJson.get(&quot;role&quot;).asText();</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">      return &quot;maintainer&quot;.equalsIgnoreCase(role)</span>
<span class="fc" id="L195">          ? TeamStatus.TEAM_MAINTAINER</span>
<span class="fc" id="L196">          : TeamStatus.TEAM_MEMBER;</span>
<span class="fc" id="L197">    } catch (HttpClientErrorException e) {</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">      if (e.getStatusCode().value() == 404) {</span>
<span class="fc" id="L199">        return TeamStatus.NOT_ORG_MEMBER; // User is not a member of the team</span>
      }
<span class="fc" id="L201">      throw e;</span>
    }
  }

  /**
   * Adds a member to a GitHub team.
   *
   * @param githubLogin The GitHub login of the user to add
   * @param teamSlug The GitHub team slug (name)
   * @param role The role to assign (&quot;member&quot; or &quot;maintainer&quot;)
   * @param course The course containing the organization
   * @return The resulting team status
   * @throws JsonProcessingException if there is an error processing JSON
   * @throws NoSuchAlgorithmException if there is an algorithm error
   * @throws InvalidKeySpecException if there is a key specification error
   */
  public TeamStatus addMemberToGithubTeam(
      String githubLogin, Integer teamId, String role, Course course, Integer orgId)
      throws JsonProcessingException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="fc" id="L220">    String endpoint =</span>
        &quot;https://api.github.com/organizations/&quot;
            + orgId
            + &quot;/team/&quot;
            + teamId
            + &quot;/memberships/&quot;
            + githubLogin;
<span class="fc" id="L227">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L228">    String token = jwtService.getInstallationToken(course);</span>
<span class="fc" id="L229">    headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);</span>
<span class="fc" id="L230">    headers.add(&quot;Accept&quot;, &quot;application/vnd.github+json&quot;);</span>
<span class="fc" id="L231">    headers.add(&quot;X-GitHub-Api-Version&quot;, &quot;2022-11-28&quot;);</span>

<span class="fc" id="L233">    Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="fc" id="L234">    body.put(&quot;role&quot;, role);</span>
<span class="fc" id="L235">    String bodyAsJson = objectMapper.writeValueAsString(body);</span>
<span class="fc" id="L236">    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(bodyAsJson, headers);</span>

<span class="fc" id="L238">    ResponseEntity&lt;String&gt; response =</span>
<span class="fc" id="L239">        restTemplate.exchange(endpoint, HttpMethod.PUT, entity, String.class);</span>
<span class="fc" id="L240">    JsonNode responseJson = objectMapper.readTree(response.getBody());</span>
<span class="fc" id="L241">    String resultRole = responseJson.get(&quot;role&quot;).asText();</span>
<span class="fc" id="L242">    log.info(&quot;Added user '{}' to team ID {} with role '{}'&quot;, githubLogin, teamId, resultRole);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">    return &quot;maintainer&quot;.equalsIgnoreCase(resultRole)</span>
<span class="fc" id="L244">        ? TeamStatus.TEAM_MAINTAINER</span>
<span class="fc" id="L245">        : TeamStatus.TEAM_MEMBER;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>