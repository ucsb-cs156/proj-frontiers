<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PushTeamsToGithubJob.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontiers</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.frontiers.jobs</a> &gt; <span class="el_source">PushTeamsToGithubJob.java</span></div><h1>PushTeamsToGithubJob.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.frontiers.jobs;

import edu.ucsb.cs156.frontiers.entities.Course;
import edu.ucsb.cs156.frontiers.entities.RosterStudent;
import edu.ucsb.cs156.frontiers.entities.Team;
import edu.ucsb.cs156.frontiers.entities.TeamMember;
import edu.ucsb.cs156.frontiers.enums.TeamStatus;
import edu.ucsb.cs156.frontiers.repositories.CourseRepository;
import edu.ucsb.cs156.frontiers.repositories.TeamMemberRepository;
import edu.ucsb.cs156.frontiers.repositories.TeamRepository;
import edu.ucsb.cs156.frontiers.services.GithubTeamService;
import edu.ucsb.cs156.frontiers.services.jobs.JobContext;
import edu.ucsb.cs156.frontiers.services.jobs.JobContextConsumer;
import java.util.Optional;
import lombok.Builder;

@Builder
public class PushTeamsToGithubJob implements JobContextConsumer {
  Long courseId;
  CourseRepository courseRepository;
  TeamRepository teamRepository;
  TeamMemberRepository teamMemberRepository;
  GithubTeamService githubTeamService;

  @Override
  public void accept(JobContext ctx) throws Exception {
<span class="fc" id="L27">    ctx.log(&quot;Starting push teams to GitHub job for course ID: &quot; + courseId);</span>

    // Get the course
<span class="fc" id="L30">    Optional&lt;Course&gt; courseOpt = courseRepository.findById(courseId);</span>
<span class="fc bfc" id="L31" title="All 2 branches covered.">    if (courseOpt.isEmpty()) {</span>
<span class="fc" id="L32">      ctx.log(&quot;ERROR: Course with ID &quot; + courseId + &quot; not found&quot;);</span>
<span class="fc" id="L33">      return;</span>
    }
<span class="fc" id="L35">    Course course = courseOpt.get();</span>
<span class="fc" id="L36">    ctx.log(&quot;Processing course: &quot; + course.getCourseName() + &quot; (org: &quot; + course.getOrgName() + &quot;)&quot;);</span>

<span class="fc bfc" id="L38" title="All 4 branches covered.">    if (course.getOrgName() == null || course.getInstallationId() == null) {</span>
<span class="fc" id="L39">      ctx.log(&quot;ERROR: Course has no linked GitHub organization&quot;);</span>
<span class="fc" id="L40">      return;</span>
    }

    // Get the organization id

<span class="fc" id="L45">    Integer orgId = null;</span>
    try {
<span class="fc" id="L47">      orgId = githubTeamService.getOrgId(course.getOrgName(), course);</span>

<span class="fc" id="L49">    } catch (Exception e) {</span>
<span class="fc" id="L50">      ctx.log(</span>
          &quot;ERROR: Failed to get organization ID for org: &quot;
<span class="fc" id="L52">              + course.getOrgName()</span>
              + &quot; - &quot;
<span class="fc" id="L54">              + e.getMessage());</span>
<span class="fc" id="L55">      return;</span>
<span class="fc" id="L56">    }</span>

    // Get all teams for this course
<span class="fc" id="L59">    Iterable&lt;Team&gt; teams = teamRepository.findByCourseId(courseId);</span>

    // First pass: Create teams on GitHub and update githubTeamId
<span class="fc bfc" id="L62" title="All 2 branches covered.">    for (Team team : teams) {</span>
<span class="fc" id="L63">      ctx.log(&quot;Processing team: &quot; + team.getName());</span>
      try {
<span class="fc" id="L65">        Integer githubTeamId = githubTeamService.createOrGetTeamId(team, course);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (!githubTeamId.equals(team.getGithubTeamId())) {</span>
<span class="fc" id="L67">          team.setGithubTeamId(githubTeamId);</span>
<span class="fc" id="L68">          teamRepository.save(team);</span>
<span class="fc" id="L69">          ctx.log(&quot;Updated team '&quot; + team.getName() + &quot;' with GitHub team ID: &quot; + githubTeamId);</span>
        } else {
<span class="fc" id="L71">          ctx.log(</span>
<span class="fc" id="L72">              &quot;Team '&quot; + team.getName() + &quot;' already has correct GitHub team ID: &quot; + githubTeamId);</span>
        }
<span class="fc" id="L74">      } catch (Exception e) {</span>
<span class="fc" id="L75">        ctx.log(&quot;ERROR: Failed to create/get team '&quot; + team.getName() + &quot;': &quot; + e.getMessage());</span>
<span class="fc" id="L76">      }</span>
<span class="fc" id="L77">    }</span>

    // Second pass: Process team members
<span class="fc bfc" id="L80" title="All 2 branches covered.">    for (Team team : teams) {</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">      if (team.getGithubTeamId() == null) {</span>
<span class="fc" id="L82">        ctx.log(&quot;Skipping team members for '&quot; + team.getName() + &quot;' - no GitHub team ID&quot;);</span>
<span class="fc" id="L83">        continue;</span>
      }

<span class="fc" id="L86">      ctx.log(&quot;Processing members for team: &quot; + team.getName());</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">      for (TeamMember teamMember : team.getTeamMembers()) {</span>
<span class="fc" id="L88">        RosterStudent student = teamMember.getRosterStudent();</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (student.getGithubLogin() == null) {</span>
          // Update status to NO_GITHUB_ID
<span class="fc" id="L91">          teamMember.setTeamStatus(TeamStatus.NO_GITHUB_ID);</span>
<span class="fc" id="L92">          teamMemberRepository.save(teamMember);</span>
<span class="fc" id="L93">          ctx.log(</span>
<span class="fc" id="L94">              &quot;Student &quot; + student.getEmail() + &quot; has no GitHub login - marked as NO_GITHUB_ID&quot;);</span>
<span class="fc" id="L95">          continue;</span>
        }

        try {
          // Check current status
<span class="fc" id="L100">          TeamStatus currentStatus =</span>
<span class="fc" id="L101">              githubTeamService.getTeamMembershipStatus(</span>
<span class="fc" id="L102">                  student.getGithubLogin(), team.getGithubTeamId(), course);</span>

<span class="fc bfc" id="L104" title="All 4 branches covered.">          if (currentStatus == TeamStatus.TEAM_MEMBER</span>
              || currentStatus == TeamStatus.TEAM_MAINTAINER) {
            // Already a member, just update the status
<span class="fc" id="L107">            teamMember.setTeamStatus(currentStatus);</span>
<span class="fc" id="L108">            teamMemberRepository.save(teamMember);</span>
<span class="fc" id="L109">            ctx.log(</span>
<span class="fc" id="L110">                &quot;Student &quot; + student.getGithubLogin() + &quot; already has status: &quot; + currentStatus);</span>
          } else {
            // Add as member
<span class="fc" id="L113">            TeamStatus newStatus =</span>
<span class="fc" id="L114">                githubTeamService.addMemberToGithubTeam(</span>
<span class="fc" id="L115">                    student.getGithubLogin(), team.getGithubTeamId(), &quot;member&quot;, course, orgId);</span>
<span class="fc" id="L116">            teamMember.setTeamStatus(newStatus);</span>
<span class="fc" id="L117">            teamMemberRepository.save(teamMember);</span>
<span class="fc" id="L118">            ctx.log(</span>
<span class="fc" id="L119">                &quot;Added student &quot; + student.getGithubLogin() + &quot; to team with status: &quot; + newStatus);</span>
          }
<span class="fc" id="L121">        } catch (Exception e) {</span>
<span class="fc" id="L122">          ctx.log(</span>
              &quot;ERROR: Failed to process team member &quot;
<span class="fc" id="L124">                  + student.getGithubLogin()</span>
                  + &quot; for team '&quot;
<span class="fc" id="L126">                  + team.getName()</span>
                  + &quot;': &quot;
<span class="fc" id="L128">                  + e.getMessage());</span>
<span class="fc" id="L129">          teamMember.setTeamStatus(TeamStatus.NOT_ORG_MEMBER);</span>
<span class="fc" id="L130">          teamMemberRepository.save(teamMember);</span>
<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">      }</span>
<span class="fc" id="L133">    }</span>

<span class="fc" id="L135">    ctx.log(&quot;Completed push teams to GitHub job for course ID: &quot; + courseId);</span>
<span class="fc" id="L136">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>