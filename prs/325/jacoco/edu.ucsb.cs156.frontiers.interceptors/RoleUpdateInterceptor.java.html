<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoleUpdateInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontiers</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.frontiers.interceptors</a> &gt; <span class="el_source">RoleUpdateInterceptor.java</span></div><h1>RoleUpdateInterceptor.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.frontiers.interceptors;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;
import org.springframework.stereotype.Component;

import edu.ucsb.cs156.frontiers.repositories.AdminRepository;
import edu.ucsb.cs156.frontiers.repositories.InstructorRepository;
import org.springframework.web.servlet.HandlerInterceptor;

import java.util.HashSet;
import java.util.Set;
import java.util.Collection;

@Component
public class RoleUpdateInterceptor implements HandlerInterceptor {

    private final AdminRepository adminRepository;
    
    private final InstructorRepository instructorRepository;

<span class="fc" id="L29">    public RoleUpdateInterceptor(AdminRepository adminRepository, InstructorRepository instructorRepository) {</span>
<span class="fc" id="L30">        this.adminRepository = adminRepository;</span>
<span class="fc" id="L31">        this.instructorRepository = instructorRepository;</span>
<span class="fc" id="L32">    }</span>
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // Update user's security context on server each time the user makes HTTP request to the backend
        // If user has admin or instructor status in database, we will update their roles in security context
<span class="fc" id="L38">        SecurityContext securityContext = SecurityContextHolder.getContext();</span>
<span class="fc" id="L39">        Authentication authentication = securityContext.getAuthentication();</span>
        
<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (authentication instanceof OAuth2AuthenticationToken) {</span>
<span class="fc" id="L42">            OAuth2AuthenticationToken oauthToken = (OAuth2AuthenticationToken) authentication;</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">            if (oauthToken.getPrincipal() instanceof OidcUser) {</span>
<span class="fc" id="L44">                OidcUser oidcUser = (OidcUser) oauthToken.getPrincipal();</span>
<span class="fc" id="L45">                String email = oidcUser.getEmail();</span>
<span class="fc" id="L46">                Set&lt;GrantedAuthority&gt; newAuthorities = new HashSet&lt;&gt;();</span>
<span class="fc" id="L47">                Collection&lt;? extends GrantedAuthority&gt; currentAuthorities = authentication.getAuthorities();</span>

                // Copy all existing authorities except ROLE_ADMIN and ROLE_INSTRUCTOR
<span class="fc" id="L50">                currentAuthorities.stream()</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">                    .filter(authority -&gt; !authority.getAuthority().equals(&quot;ROLE_ADMIN&quot;) &amp;&amp;</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">                                        !authority.getAuthority().equals(&quot;ROLE_INSTRUCTOR&quot;))</span>
<span class="fc" id="L53">                    .forEach(newAuthorities::add);</span>

                // Check if user is admin or instructor and add appropriate role
<span class="fc bfc" id="L56" title="All 2 branches covered.">                if (adminRepository.existsByEmail(email)) {</span>
<span class="fc" id="L57">                    newAuthorities.add(new SimpleGrantedAuthority(&quot;ROLE_ADMIN&quot;));</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">                } else if (instructorRepository.existsByEmail(email)) {</span>
<span class="fc" id="L59">                    newAuthorities.add(new SimpleGrantedAuthority(&quot;ROLE_INSTRUCTOR&quot;));</span>
                }

                // Create new authentication with updated authorities
<span class="fc" id="L63">                Authentication newAuth = new OAuth2AuthenticationToken(</span>
                    oidcUser,
                    newAuthorities,
<span class="fc" id="L66">                    oauthToken.getAuthorizedClientRegistrationId()</span>
                );

<span class="fc" id="L69">                SecurityContextHolder.getContext().setAuthentication(newAuth);</span>
            }
        }
        
<span class="fc" id="L73">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>