<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RosterStudentService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontiers</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.frontiers.services</a> &gt; <span class="el_source">RosterStudentService.java</span></div><h1>RosterStudentService.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.frontiers.services;

import java.io.*;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

import com.opencsv.bean.CsvToBean;
import com.opencsv.bean.CsvToBeanBuilder;
import com.opencsv.bean.StatefulBeanToCsv;
import com.opencsv.bean.StatefulBeanToCsvBuilder;
import edu.ucsb.cs156.frontiers.entities.Course;
import edu.ucsb.cs156.frontiers.enums.OrgStatus;
import edu.ucsb.cs156.frontiers.enums.RosterStatus;
import edu.ucsb.cs156.frontiers.models.PreConvertRosterStudent;
import edu.ucsb.cs156.frontiers.utilities.CanonicalFormConverter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import edu.ucsb.cs156.frontiers.entities.RosterStudent;
import edu.ucsb.cs156.frontiers.models.RosterStudentDTO;
import edu.ucsb.cs156.frontiers.repositories.RosterStudentRepository;
import org.springframework.web.multipart.MultipartFile;

@Service
<span class="fc" id="L26">@Slf4j</span>
public class RosterStudentService {

    private final UpdateUserService updateUserService;

<span class="fc" id="L31">    public enum InsertStatus {</span>
<span class="fc" id="L32">        INSERTED, UPDATED, REJECTED</span>
    }

<span class="fc" id="L35">    public record LoadResult(int inserted, int updated, List&lt;RosterStudent&gt; errors) {};</span>
<span class="fc" id="L36">    public record UpsertResponse(InsertStatus insertStatus, RosterStudent rosterStudent){}</span>

    private final RosterStudentRepository rosterStudentRepository;

<span class="fc" id="L40">    public RosterStudentService( RosterStudentRepository repository, UpdateUserService updateUserService) {</span>
<span class="fc" id="L41">        this.rosterStudentRepository = repository;</span>
<span class="fc" id="L42">        this.updateUserService = updateUserService;</span>
<span class="fc" id="L43">    }</span>


    /**
     * Loads and processes a CSV file containing student information for a specific course.
     * The CSV data is parsed into student objects, and an upsert operation is performed
     * for each student to either insert or update their details in the course roster.
     * In cases where the data is invalid or rejected, the related students are tracked as failures.
     *
     * @param file the CSV file containing student data
     * @param course the Course object specifying the course to which the students belong
     * @return a LoadResult object containing the count of inserted and updated students,
     *         as well as a list of students whose entries failed to process
     * @throws IOException if an error occurs while reading or processing the file
     */
    public LoadResult loadCsv(MultipartFile file, Course course) throws IOException {
        List&lt;PreConvertRosterStudent&gt; preConvertRosterStudents;
<span class="fc" id="L60">        List&lt;RosterStudent&gt; failures = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L61">        int[] counts = {0, 0};</span>
<span class="fc" id="L62">        try (InputStream inputStream = new BufferedInputStream(file.getInputStream())) {</span>
<span class="fc" id="L63">            InputStreamReader reader = new InputStreamReader(inputStream);</span>
<span class="fc" id="L64">            CsvToBean&lt;PreConvertRosterStudent&gt; csvToBean= new CsvToBeanBuilder&lt;PreConvertRosterStudent&gt;(reader)</span>
<span class="fc" id="L65">                    .withType(PreConvertRosterStudent.class)</span>
<span class="fc" id="L66">                    .withIgnoreEmptyLine(true)</span>
<span class="fc" id="L67">                    .withFilter(line -&gt;</span>
<span class="pc bpc" id="L68" title="1 of 4 branches missed.">                        Arrays.stream(line).anyMatch(s -&gt; s != null &amp;&amp; !s.isBlank())</span>
                    )
<span class="fc" id="L70">                    .build();</span>
<span class="fc" id="L71">            preConvertRosterStudents = new ArrayList&lt;&gt;(csvToBean.parse());</span>
<span class="fc" id="L72">            preConvertRosterStudents.forEach(student -&gt; {</span>
<span class="fc" id="L73">                RosterStudent createdStudent = RosterStudent.builder()</span>
<span class="fc" id="L74">                        .studentId(student.getStudentId())</span>
<span class="fc" id="L75">                        .firstName(student.getFirstName())</span>
<span class="fc" id="L76">                        .lastName(student.getLastName())</span>
<span class="fc" id="L77">                        .email(student.getEmail())</span>
<span class="fc" id="L78">                        .course(course)</span>
<span class="fc" id="L79">                        .build();</span>
<span class="fc" id="L80">                UpsertResponse response = upsertStudent(createdStudent, course, RosterStatus.ROSTER);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                if(response.insertStatus() == InsertStatus.REJECTED) {</span>
<span class="fc" id="L82">                    failures.add(response.rosterStudent());</span>
                } else {
<span class="fc" id="L84">                    counts[response.insertStatus.ordinal()]++;</span>
                }
<span class="fc" id="L86">            });</span>
<span class="fc" id="L87">            return new LoadResult(counts[0], counts[1], failures);</span>
        }
    }


    /**
     * Performs an upsert operation for a given student into a course roster.
     * If a matching student exists based on their student ID or email, their information will be updated.
     * Otherwise, the student will be inserted as a new entry.
     * If there is a conflict between student ID and email pointing to different records, the operation is rejected.
     *
     * @param student the RosterStudent object containing student details to be upserted
     * @param course the Course object representing the course to which the student belongs
     * @param rosterStatus the RosterStatus indicating the status of the student's enrollment in the course
     * @return an UpsertResponse containing the status of the operation (INSERTED, UPDATED, or REJECTED)
     *         and the associated RosterStudent object
     */
    public UpsertResponse upsertStudent(RosterStudent student, Course course, RosterStatus rosterStatus) {
<span class="fc" id="L105">        String convertedEmail = CanonicalFormConverter.convertToValidEmail(student.getEmail());</span>
<span class="fc" id="L106">        Optional&lt;RosterStudent&gt; existingStudent = rosterStudentRepository.findByCourseIdAndStudentId(course.getId(),</span>
<span class="fc" id="L107">                student.getStudentId());</span>
<span class="fc" id="L108">        Optional&lt;RosterStudent&gt; existingStudentByEmail = rosterStudentRepository.findByCourseIdAndEmail(course.getId(),</span>
                convertedEmail);
<span class="fc bfc" id="L110" title="All 4 branches covered.">        if(existingStudent.isPresent() &amp;&amp; existingStudentByEmail.isPresent()) {</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">            if (!Objects.equals(existingStudent.get().getId(), existingStudentByEmail.get().getId())) {</span>
<span class="fc" id="L112">                return new UpsertResponse(InsertStatus.REJECTED, student);</span>
            } else {
<span class="fc" id="L114">                RosterStudent selectedStudent = existingStudent.get();</span>
<span class="fc" id="L115">                selectedStudent.setRosterStatus(rosterStatus);</span>
<span class="fc" id="L116">                selectedStudent.setFirstName(student.getFirstName());</span>
<span class="fc" id="L117">                selectedStudent.setLastName(student.getLastName());</span>
<span class="fc" id="L118">                rosterStudentRepository.save(selectedStudent);</span>
<span class="fc" id="L119">                updateUserService.attachUserToRosterStudent(selectedStudent);</span>
<span class="fc" id="L120">                return new UpsertResponse(InsertStatus.UPDATED, selectedStudent);</span>
            }
<span class="fc bfc" id="L122" title="All 4 branches covered.">        } else if (existingStudent.isPresent() || existingStudentByEmail.isPresent()) {</span>
<span class="fc" id="L123">            RosterStudent existingStudentObj = existingStudent.orElseGet(existingStudentByEmail::get);</span>
<span class="fc" id="L124">            existingStudentObj.setRosterStatus(rosterStatus);</span>
<span class="fc" id="L125">            existingStudentObj.setFirstName(student.getFirstName());</span>
<span class="fc" id="L126">            existingStudentObj.setLastName(student.getLastName());</span>
<span class="fc" id="L127">            existingStudentObj.setEmail(convertedEmail);</span>
<span class="fc" id="L128">            existingStudentObj.setStudentId(student.getStudentId());</span>
<span class="fc" id="L129">            existingStudentObj = rosterStudentRepository.save(existingStudentObj);</span>
<span class="fc" id="L130">            updateUserService.attachUserToRosterStudent(existingStudentObj);</span>
<span class="fc" id="L131">            return new RosterStudentService.UpsertResponse(RosterStudentService.InsertStatus.UPDATED, existingStudentObj);</span>
        } else {
<span class="fc" id="L133">            student.setRosterStatus(rosterStatus);</span>
            //if an installationID exists, orgStatus should be set to JOINCOURSE. if it doesn't exist (null), set orgStatus to PENDING.
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if(course.getInstallationId() != null) {</span>
<span class="fc" id="L136">                student.setOrgStatus(OrgStatus.JOINCOURSE);</span>
            } else {
<span class="fc" id="L138">                student.setOrgStatus(OrgStatus.PENDING);</span>
            }
<span class="fc" id="L140">            student = rosterStudentRepository.save(student);</span>
<span class="fc" id="L141">            updateUserService.attachUserToRosterStudent(student);</span>
<span class="fc" id="L142">            return new RosterStudentService.UpsertResponse(RosterStudentService.InsertStatus.INSERTED, student);</span>
        }
    }

    /**
     * This method gets a list of RosterStudentDTOs based on the courseId
     * 
     * @param courseId if of the course
     * @return a list of RosterStudentDTOs
     */
    public List&lt;RosterStudentDTO&gt; getRosterStudentDTOs(Long courseId) {
<span class="fc" id="L153">        Iterable&lt;RosterStudent&gt; matchedStudents = rosterStudentRepository.findByCourseId(courseId);</span>
        
<span class="fc" id="L155">        return StreamSupport.stream(matchedStudents.spliterator(), false)</span>
<span class="fc" id="L156">            .map(RosterStudentDTO::new)</span>
<span class="fc" id="L157">            .collect(Collectors.toList());</span>

    }

    public StatefulBeanToCsv&lt;RosterStudentDTO&gt; getStatefulBeanToCSV(Writer writer) throws IOException {
<span class="fc" id="L162">        return new StatefulBeanToCsvBuilder&lt;RosterStudentDTO&gt;(writer).build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>